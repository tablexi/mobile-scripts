#!/usr/bin/ruby

platform = ARGV[0]
emulator = ARGV[1]

if !platform
  puts "No platform specified. Available platforms: (ios|android)"
  exit
elsif platform == 'android' && !emulator
  puts "No emulator specified. Existing emulators: (avdmanager list avd)"
  system "avdmanager list avd"
  exit
end
begin
  pid = Process.spawn "npm run storybook"
  # give storybook time to grab the socket port
  sleep (5)
  if emulator
    Process.spawn("emulator -avd #{emulator}")
    sleep(5)
  end
  
  system "react-native run-#{platform}"
  system "open http://localhost:7007"
  Process.wait(pid)
rescue Exception => ex
  puts "================== Error, stopping dev script ========================"
  puts ex
ensure
  Process.kill("HUP", pid)
end